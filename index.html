<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Kitten</title>
    <script>
      const ipc = require('electron').ipcRenderer
      const fs = require('fs')
      const path = require('path')
      //const shell = require('electron').shell
      const os = require('os')

      let isDirectory = null
      let getDirectories = null
      let getFiles = null

      let kitSelect = null
      let curPlayer = 1
      let state = ''
      let dirSep = '/'
      let audioDir = ''
      let audioExt = '.meow'

      ipc.on('message', function (event, message) {
        console.log(`Message from main: ${message}`)
      })

      ipc.on('command', function (event, message) {
        console.log(message)
        doCommand(message)
      })

      function init(){
        kitSelect = document.getElementById('kit')

        if(os.platform() == 'win32'){
          dirSep = '\\'
        }

        audioDir = 'audio'+dirSep

        //event listeners
        //document.getElementById('kit').onchange = event =>
        //end event listeners

        //from https://stackoverflow.com/a/24594123/1317558
        isDirectory = source => fs.lstatSync(source).isDirectory()
        getDirectories = source =>
          fs.readdirSync(source).map(name => path.join(source, name)).filter(isDirectory)

        getFiles = source =>
          fs.readdirSync(source).map(name => path.join(source, name)).filter
          (source => !fs.lstatSync(source).isDirectory())

        getDirectories(audioDir).forEach(function(element) {
          let dir = element.split(dirSep)
          dir = dir[dir.length -1]
          let op = document.createElement('OPTION')
          op.text = dir
          op.value = element
          kitSelect.options.add(op)
        })
      }

      //returns the current audio player
      function getCurPlayer(){
        let elId = null
        if(curPlayer){
          elId = 'player1'
        }
        else {
          elId = 'player0'
        }
        return document.getElementById(elId)
      }

      //sets up and returns the next audio player.
      //src: the audio to play
      function getPlayer(src){
        let elId = null
        if(curPlayer){
          curPlayer = 0
          elId = 'player0'
        }
        else {
          curPlayer++
          elId = 'player1'
        }
        let containerEl = document.getElementById(elId+'Holder')

        containerEl.innerHTML = '<audio controls id="'+elId+'">'
        //containerEl.innerHTML += '<source src="'+src.replace(/\\/g,'/')+'"/>'
        containerEl.innerHTML += '</audio>'

        let srcel = document.createElement('SOURCE')
        srcel.src = src.replace(/\\/g,'/')

        let plyr = document.getElementById(elId)

        plyr.appendChild(srcel)

        return document.getElementById(elId)
      }

      function getKitPath(){
        let files = getFiles(kitSelect.value)
        let exts = []
        for(let i=0; i<files.length; i++){
          let ext = files[i].split('.')
          ext = ext[ext.length - 1]
          if(typeof exts[ext] !== 'undefined'){
            audioExt = '.'+ext
            break;
          }
          else{
            exts[ext] = 1
          }
        }

        return kitSelect.value + dirSep
      }

      function doCommand(message){
        if(message != state){
          if(message == 'mvp'){
            let player = getPlayer(getKitPath()+'roundmvpanthem_01'+audioExt)
            player.oncanplay = function(){
              player.play()
            }
            player.load()
          }
          else if (message == 'test') {
            if(state == 'mvp'){
              fadeOut(getCurPlayer())
            }
          }
          else {
            console.log('if you\'re seeing this, javascript determined that '+message+' != mvp')
          }
          state = message
        }
      }

      //heavily inspired by fade.js by miohtama
      //ramp() is is almost identical to original implementation
      //https://github.com/miohtama/Krusovice/blob/master/src/tools/fade.js
      function fadeOut(player)
      {
        if(player != null){
          let oVol = player.volume
          if(oVol != 0){
            let timeToFade = 500
            let tick = 50

            let volumeStep = oVol / (timeToFade / tick)

            function ramp() {
              let vol = Math.max(0, player.volume - volumeStep)

              player.volume = vol

              // Have we reached target volume level yet?
              if(player.volume > 0) {
                // Keep up going until 11
                setTimeout(ramp, tick)
              } else {
                player.pause()
                // Reset audio volume so audio can be played again
                player.volume = orignalVolume
              }
            }
            ramp()
          }
        }
      }
    </script>
  </head>
  <body onload="init()">
    <div>
      <h1 id="h1">CS:GO Kitten</h1>
      <label for="kit">Music Pack: </label><select id="kit">
      </select>
      <!--<button>Open music directory</button>-->
    </div>
    <div id="player0Holder">
    </div>
    <div id="player1Holder">
    </div>
  </body>
</html>
